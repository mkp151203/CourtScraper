<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Indian Court Case Scraper</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        select, input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .captcha-container {
            text-align: center;
            margin: 20px 0;
        }

        .captcha-image {
            max-width: 300px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .result-section {
            margin-top: 30px;
        }

        .result-card {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
        }

        .result-card h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .result-item {
            display: flex;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-label {
            font-weight: 600;
            width: 200px;
            color: #555;
        }

        .result-value {
            flex: 1;
            color: #333;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-error {
            background: #fee;
            color: #c00;
            border: 1px solid #fcc;
        }

        .alert-success {
            background: #efe;
            color: #0a0;
            border: 1px solid #cfc;
        }

        .court-type-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }

        .court-type-btn {
            flex: 1;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .court-type-btn:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .court-type-btn.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .court-type-btn h3 {
            margin-bottom: 5px;
        }

        .order-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .court-type-selector {
                flex-direction: column;
            }

            .result-item {
                flex-direction: column;
            }

            .result-label {
                width: 100%;
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèõÔ∏è Indian Court Case Scraper</h1>
            <p>Search High Courts and District Courts across India</p>
        </div>

        <div class="card">
            <div class="court-type-selector">
                <div class="court-type-btn active" onclick="selectCourtType('high-court')">
                    <h3>High Court</h3>
                    <p>Search all High Courts</p>
                </div>
                <div class="court-type-btn" onclick="selectCourtType('district-court')">
                    <h3>District Court</h3>
                    <p>Search District & Taluka Courts</p>
                </div>
                <div class="court-type-btn" onclick="selectCourtType('causelist')">
                    <h3>HC Cause List</h3>
                    <p>Search High Court Cause Lists</p>
                </div>
                <div class="court-type-btn" onclick="selectCourtType('district-causelist')">
                    <h3>DC Cause List</h3>
                    <p>Search District Court Cause Lists</p>
                </div>
            </div>

            <div id="alert-container"></div>

            <!-- High Court Form -->
            <div id="high-court-form">
                <div class="form-group">
                    <label for="hc-court">Select High Court</label>
                    <select id="hc-court" onchange="onHighCourtChange()">
                        <option value="">Loading courts...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="hc-case-type">Case Type</label>
                    <select id="hc-case-type">
                        <option value="">Select court first</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="hc-case-number">Case Number</label>
                    <input type="text" id="hc-case-number" placeholder="e.g., 16516">
                </div>

                <div class="form-group">
                    <label for="hc-year">Year</label>
                    <input type="text" id="hc-year" placeholder="e.g., 2022">
                </div>

                <button class="btn" onclick="searchHighCourt()">Search Case</button>
            </div>

            <!-- District Court Form -->
            <div id="district-court-form" class="hidden">
                <div class="form-group">
                    <label for="dc-state">Select State</label>
                    <select id="dc-state" onchange="onStateChange()">
                        <option value="">Select state</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="dc-district">Select District</label>
                    <select id="dc-district" onchange="onDistrictChange()">
                        <option value="">Select state first</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="dc-court-complex">Select Court Complex</label>
                    <select id="dc-court-complex" onchange="onCourtComplexChange()">
                        <option value="">Select district first</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="dc-case-type">Case Type</label>
                    <select id="dc-case-type">
                        <option value="">Select court complex first</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="dc-case-number">Case Number</label>
                    <input type="text" id="dc-case-number" placeholder="e.g., 100591">
                </div>

                <div class="form-group">
                    <label for="dc-year">Year</label>
                    <input type="text" id="dc-year" placeholder="e.g., 2016">
                </div>

                <button class="btn" onclick="searchDistrictCourt()">Search Case</button>
            </div>

            <!-- Cause List Form -->
            <div id="causelist-form" class="hidden">
                <div class="form-group">
                    <label for="cl-court">Select High Court</label>
                    <select id="cl-court" onchange="onCauseListCourtChange()">
                        <option value="">Loading courts...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="cl-bench">Select Bench/Location (Optional)</label>
                    <select id="cl-bench">
                        <option value="">All Benches</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="cl-date">Cause List Date</label>
                    <input type="date" id="cl-date">
                </div>

                <div class="form-group">
                    <label for="cl-search-type">Search Type</label>
                    <select id="cl-search-type">
                        <option value="case_number">Case Number</option>
                        <option value="party_name">Party Name</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="cl-search-term">Search Term</label>
                    <input type="text" id="cl-search-term" placeholder="e.g., WP/1234/2024 or party name">
                </div>

                <button class="btn" onclick="searchCauseList()">Search Cause List</button>
            </div>

            <!-- District Cause List Form -->
            <div id="district-causelist-form" class="hidden">
                <div class="form-group">
                    <label for="dcl-state">Select State</label>
                    <select id="dcl-state" onchange="onDCLStateChange()">
                        <option value="">Select state</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="dcl-district">Select District</label>
                    <select id="dcl-district" onchange="onDCLDistrictChange()">
                        <option value="">Select state first</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="dcl-court-complex">Select Court Complex</label>
                    <select id="dcl-court-complex" onchange="onDCLComplexChange()">
                        <option value="">Select district first</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="dcl-establishment">Select Establishment (Court Type)</label>
                    <select id="dcl-establishment" onchange="onDCLEstablishmentChange()">
                        <option value="">Select court complex first</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="dcl-judge">Select Judge/Court Number</label>
                    <select id="dcl-judge">
                        <option value="">Select establishment first</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="dcl-date">Cause List Date</label>
                    <input type="date" id="dcl-date">
                </div>

                <div class="form-group">
                    <label for="dcl-case-type">Case Type</label>
                    <select id="dcl-case-type">
                        <option value="civ">Civil</option>
                        <option value="cri">Criminal</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="dcl-search-type">Search Type</label>
                    <select id="dcl-search-type">
                        <option value="case_number">Case Number</option>
                        <option value="party_name">Party Name</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="dcl-search-term">Search Term</label>
                    <input type="text" id="dcl-search-term" placeholder="e.g., 123/2024 or party name">
                </div>

                <button class="btn" onclick="searchDistrictCauseList()">Search Cause List</button>
            </div>
        </div>

        <!-- Captcha Modal -->
        <div id="captcha-modal" class="card hidden">
            <h2 style="margin-bottom: 20px;">Solve Captcha</h2>
            <div class="captcha-container">
                <img id="captcha-image" class="captcha-image" src="" alt="Captcha">
            </div>
            <div class="form-group">
                <label for="captcha-input">Enter Captcha Text</label>
                <input type="text" id="captcha-input" placeholder="Enter the text shown above">
            </div>
            <button class="btn" onclick="submitCaptcha()">Submit</button>
        </div>

        <!-- Loading -->
        <div id="loading-indicator" class="card hidden">
            <div class="loading">
                <div class="spinner"></div>
                <p style="margin-top: 15px;" id="loading-message">Loading...</p>
                <div id="progress-container" style="margin-top: 15px; display: none;">
                    <div style="background: #e0e0e0; border-radius: 10px; height: 8px; overflow: hidden;">
                        <div id="progress-bar" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 100%; width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <p id="progress-text" style="margin-top: 10px; font-size: 14px; color: #666;"></p>
                    <div id="progress-log" style="margin-top: 10px; max-height: 200px; overflow-y: auto; text-align: left; font-size: 12px; color: #888; font-family: monospace; background: #f9fafb; padding: 10px; border-radius: 5px; display: none;"></div>
                </div>
            </div>
        </div>

        <!-- Results -->
        <div id="results-container" class="hidden">
            <div class="card">
                <h2 style="margin-bottom: 20px;">Case Details</h2>
                <div id="results-content"></div>
            </div>
        </div>
    </div>

    <script>
        let currentCourtType = 'high-court';
        let currentQueryData = {};
        let causelistSessionId = null; // Store causelist session for PDF downloads
        let highCourts = [];
        let causeListCourts = [];
        let states = {};
        let districtCauseListSessionId = null; // Session for dropdown continuity

        // Initialize
        window.onload = function() {
            loadHighCourts();
            loadStates();
            loadCauseListCourts();
            loadDistrictCauseListStates();
            
            // Set today's date as default for causelists
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('cl-date').value = today;
            document.getElementById('dcl-date').value = today;
        };

        function selectCourtType(type) {
            currentCourtType = type;
            
            // Update button styles
            document.querySelectorAll('.court-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('.court-type-btn').classList.add('active');
            
            // Show/hide forms
            document.getElementById('high-court-form').classList.toggle('hidden', type !== 'high-court');
            document.getElementById('district-court-form').classList.toggle('hidden', type !== 'district-court');
            document.getElementById('causelist-form').classList.toggle('hidden', type !== 'causelist');
            document.getElementById('district-causelist-form').classList.toggle('hidden', type !== 'district-causelist');
            
            // Hide results
            hideResults();
        }

        async function loadHighCourts() {
            try {
                const response = await fetch('/api/high-court/courts');
                const data = await response.json();
                
                if (data.success) {
                    highCourts = data.courts;
                    const select = document.getElementById('hc-court');
                    select.innerHTML = '<option value="">Select High Court</option>';
                    
                    data.courts.forEach(court => {
                        const option = document.createElement('option');
                        option.value = JSON.stringify(court);
                        option.textContent = court.court_name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                showAlert('Failed to load High Courts', 'error');
            }
        }

        async function loadStates() {
            try {
                const response = await fetch('/api/district-court/states');
                const data = await response.json();
                
                if (data.success) {
                    states = data.states;
                    const select = document.getElementById('dc-state');
                    select.innerHTML = '<option value="">Select State</option>';
                    
                    Object.keys(states).sort().forEach(stateName => {
                        const option = document.createElement('option');
                        option.value = states[stateName];
                        option.textContent = stateName;
                        option.dataset.name = stateName;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                showAlert('Failed to load states', 'error');
            }
        }

        async function loadCauseListCourts() {
            try {
                const response = await fetch('/api/causelist/courts');
                const data = await response.json();
                
                if (data.success) {
                    causeListCourts = data.courts;
                    const select = document.getElementById('cl-court');
                    select.innerHTML = '<option value="">Select High Court</option>';
                    
                    data.courts.forEach(court => {
                        // Skip the "Select Highcourt" placeholder option
                        if (court.state_code === "0" || court.court_code === "0") {
                            return;
                        }
                        
                        const option = document.createElement('option');
                        option.value = JSON.stringify(court);
                        option.textContent = court.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                showAlert('Failed to load courts for cause list', 'error');
            }
        }

        async function onCauseListCourtChange() {
            const select = document.getElementById('cl-court');
            const courtData = JSON.parse(select.value || '{}');
            
            if (!courtData.state_code) return;
            
            showLoading();
            
            try {
                const response = await fetch('/api/causelist/benches', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        state_code: courtData.state_code
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const benchSelect = document.getElementById('cl-bench');
                    benchSelect.innerHTML = '<option value="">All Benches</option>';
                    
                    data.benches.forEach(bench => {
                        const option = document.createElement('option');
                        option.value = bench.court_code;
                        option.textContent = bench.name;
                        benchSelect.appendChild(option);
                    });
                }
            } catch (error) {
                showAlert('Failed to load benches', 'error');
            } finally {
                hideLoading();
            }
        }

        async function onHighCourtChange() {
            const select = document.getElementById('hc-court');
            const courtData = JSON.parse(select.value || '{}');
            
            if (!courtData.court_code) return;
            
            showLoading();
            
            try {
                const response = await fetch('/api/high-court/case-types', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        court_code: courtData.court_code,
                        state_code: courtData.state_code
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const caseTypeSelect = document.getElementById('hc-case-type');
                    caseTypeSelect.innerHTML = '<option value="">Select Case Type</option>';
                    
                    Object.entries(data.case_types).forEach(([code, name]) => {
                        const option = document.createElement('option');
                        option.value = code;
                        option.textContent = `${name} (${code})`;
                        caseTypeSelect.appendChild(option);
                    });
                }
            } catch (error) {
                showAlert('Failed to load case types', 'error');
            } finally {
                hideLoading();
            }
        }

        async function onStateChange() {
            const select = document.getElementById('dc-state');
            const stateCode = select.value;
            const stateName = select.options[select.selectedIndex].dataset.name;
            
            if (!stateCode) return;
            
            showLoading();
            
            try {
                const response = await fetch('/api/district-court/districts', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        state_code: stateCode,
                        state_name: stateName
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const districtSelect = document.getElementById('dc-district');
                    districtSelect.innerHTML = '<option value="">Select District</option>';
                    
                    Object.entries(data.districts).forEach(([name, code]) => {
                        const option = document.createElement('option');
                        option.value = code;
                        option.textContent = name;
                        option.dataset.name = name;
                        districtSelect.appendChild(option);
                    });
                    
                    // Reset dependent dropdowns
                    document.getElementById('dc-court-complex').innerHTML = '<option value="">Select district first</option>';
                    document.getElementById('dc-case-type').innerHTML = '<option value="">Select court complex first</option>';
                } else {
                    showAlert(data.error || 'Failed to load districts', 'error');
                }
            } catch (error) {
                console.error('Error loading districts:', error);
                showAlert('Failed to load districts: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        async function onDistrictChange() {
            const stateSelect = document.getElementById('dc-state');
            const districtSelect = document.getElementById('dc-district');
            
            const stateCode = stateSelect.value;
            const districtCode = districtSelect.value;
            
            // Get names from the selected options
            const stateOption = stateSelect.options[stateSelect.selectedIndex];
            const districtOption = districtSelect.options[districtSelect.selectedIndex];
            
            const stateName = stateOption ? stateOption.dataset.name : '';
            const districtName = districtOption ? districtOption.textContent : '';
            
            if (!districtCode || !stateCode) {
                return;
            }
            
            showLoading();
            
            try {
                const response = await fetch('/api/district-court/court-complexes', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        state_code: stateCode,
                        state_name: stateName,
                        district_code: districtCode,
                        district_name: districtName
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const complexSelect = document.getElementById('dc-court-complex');
                    complexSelect.innerHTML = '<option value="">Select Court Complex</option>';
                    
                    Object.entries(data.court_complexes).forEach(([name, code]) => {
                        const option = document.createElement('option');
                        option.value = code;
                        option.textContent = name;
                        option.dataset.name = name;
                        complexSelect.appendChild(option);
                    });
                    
                    // Reset case types
                    document.getElementById('dc-case-type').innerHTML = '<option value="">Select court complex first</option>';
                } else {
                    showAlert(data.error || 'Failed to load court complexes', 'error');
                }
            } catch (error) {
                showAlert('Failed to load court complexes: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        async function onCourtComplexChange() {
            const stateSelect = document.getElementById('dc-state');
            const districtSelect = document.getElementById('dc-district');
            const complexSelect = document.getElementById('dc-court-complex');
            
            const stateCode = stateSelect.value;
            const stateName = stateSelect.options[stateSelect.selectedIndex].dataset.name;
            const districtCode = districtSelect.value;
            const districtName = districtSelect.options[districtSelect.selectedIndex].dataset.name;
            const complexCode = complexSelect.value;
            const complexName = complexSelect.options[complexSelect.selectedIndex].dataset.name;
            
            if (!complexCode) return;
            
            showLoading();
            
            try {
                const response = await fetch('/api/district-court/case-types', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        state_code: stateCode,
                        state_name: stateName,
                        district_code: districtCode,
                        district_name: districtName,
                        court_complex_code: complexCode,
                        court_complex_name: complexName
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const caseTypeSelect = document.getElementById('dc-case-type');
                    caseTypeSelect.innerHTML = '<option value="">Select Case Type</option>';
                    
                    Object.entries(data.case_types).forEach(([name, code]) => {
                        const option = document.createElement('option');
                        option.value = code;
                        option.textContent = name;
                        caseTypeSelect.appendChild(option);
                    });
                }
            } catch (error) {
                showAlert('Failed to load case types', 'error');
            } finally {
                hideLoading();
            }
        }

        async function searchHighCourt() {
            const select = document.getElementById('hc-court');
            const courtData = JSON.parse(select.value || '{}');
            const caseType = document.getElementById('hc-case-type').value;
            const caseNumber = document.getElementById('hc-case-number').value;
            const year = document.getElementById('hc-year').value;
            
            if (!courtData.court_code || !caseType || !caseNumber || !year) {
                showAlert('Please fill all fields', 'error');
                return;
            }
            
            showLoading();
            
            currentQueryData = {
                court_code: courtData.court_code,
                state_code: courtData.state_code,
                court_name: courtData.court_name,
                case_type: caseType,
                case_number: caseNumber,
                year: year
            };
            
            try {
                const response = await fetch('/api/high-court/search', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(currentQueryData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentQueryData.query_id = data.query_id;
                    currentQueryData.session_id = data.session_id; // Store session ID
                    showCaptcha(data.captcha_url);
                } else {
                    showAlert(data.error || 'Failed to search', 'error');
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        async function searchDistrictCourt() {
            const stateSelect = document.getElementById('dc-state');
            const districtSelect = document.getElementById('dc-district');
            const complexSelect = document.getElementById('dc-court-complex');
            const caseType = document.getElementById('dc-case-type').value;
            const caseNumber = document.getElementById('dc-case-number').value;
            const year = document.getElementById('dc-year').value;
            
            if (!stateSelect.value || !districtSelect.value || !complexSelect.value || !caseType || !caseNumber || !year) {
                showAlert('Please fill all fields', 'error');
                return;
            }
            
            showLoading();
            
            currentQueryData = {
                state_code: stateSelect.value,
                state_name: stateSelect.options[stateSelect.selectedIndex]?.dataset?.name || stateSelect.options[stateSelect.selectedIndex]?.textContent || '',
                district_code: districtSelect.value,
                district_name: districtSelect.options[districtSelect.selectedIndex]?.textContent || '',
                court_complex_code: complexSelect.value,
                court_complex_name: complexSelect.options[complexSelect.selectedIndex]?.textContent || '',
                case_type: caseType,
                case_number: caseNumber,
                year: year
            };
            
            try {
                const response = await fetch('/api/district-court/search', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(currentQueryData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentQueryData.query_id = data.query_id;
                    currentQueryData.session_id = data.session_id; // Store session ID
                    showCaptcha(data.captcha_url);
                } else {
                    showAlert(data.error || 'Failed to search', 'error');
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        async function searchCauseList() {
            const select = document.getElementById('cl-court');
            const courtData = JSON.parse(select.value || '{}');
            const benchSelect = document.getElementById('cl-bench');
            const courtCode = benchSelect.value || courtData.state_code; // Use bench or default court code
            const dateInput = document.getElementById('cl-date').value;
            const searchType = document.getElementById('cl-search-type').value;
            const searchTerm = document.getElementById('cl-search-term').value.trim();
            
            if (!courtData.state_code || !dateInput || !searchTerm) {
                showAlert('Please fill all required fields', 'error');
                return;
            }
            
            // Convert date from YYYY-MM-DD to DD-MM-YYYY
            const dateParts = dateInput.split('-');
            const formattedDate = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;
            
            showLoading();
            
            currentQueryData = {
                state_code: courtData.state_code,
                court_code: courtCode,
                court_name: courtData.name,
                bench_name: benchSelect.options[benchSelect.selectedIndex]?.textContent || 'All Benches',
                date: formattedDate,
                search_term: searchTerm,
                is_party_name: searchType === 'party_name'
            };
            
            try {
                const response = await fetch('/api/causelist/search', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(currentQueryData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentQueryData.query_id = data.query_id;
                    currentQueryData.session_id = data.session_id;
                    showCaptcha(data.captcha_url);
                } else {
                    showAlert(data.error || 'Failed to initialize search', 'error');
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // ==================== DISTRICT CAUSELIST FUNCTIONS ====================

        async function loadDistrictCauseListStates() {
            try {
                // Initialize session first
                const sessionResponse = await fetch('/api/district-causelist/init-session', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                const sessionData = await sessionResponse.json();
                if (sessionData.success) {
                    districtCauseListSessionId = sessionData.session_id;
                    console.log('District causelist session initialized:', districtCauseListSessionId);
                }
                
                const response = await fetch('/api/district-causelist/states');
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('dcl-state');
                    select.innerHTML = '<option value="">Select State</option>';
                    
                    Object.keys(data.states).sort().forEach(stateName => {
                        const option = document.createElement('option');
                        option.value = data.states[stateName];
                        option.textContent = stateName;
                        option.dataset.name = stateName;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                showAlert('Failed to load states for district causelist', 'error');
            }
        }

        async function onDCLStateChange() {
            const select = document.getElementById('dcl-state');
            const stateCode = select.value;
            const stateName = select.options[select.selectedIndex]?.dataset?.name || '';
            
            if (!stateCode) return;
            
            showLoading();
            
            try {
                const response = await fetch('/api/district-causelist/districts', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        state_code: stateCode,
                        session_id: districtCauseListSessionId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const districtSelect = document.getElementById('dcl-district');
                    districtSelect.innerHTML = '<option value="">Select District</option>';
                    
                    Object.entries(data.districts).forEach(([name, code]) => {
                        const option = document.createElement('option');
                        option.value = code;
                        option.textContent = name;
                        option.dataset.name = name;
                        districtSelect.appendChild(option);
                    });
                    
                    // Reset dependent dropdowns
                    document.getElementById('dcl-court-complex').innerHTML = '<option value="">Select district first</option>';
                    document.getElementById('dcl-establishment').innerHTML = '<option value="">Select court complex first</option>';
                    document.getElementById('dcl-judge').innerHTML = '<option value="">Select establishment first</option>';
                }
            } catch (error) {
                showAlert('Failed to load districts', 'error');
            } finally {
                hideLoading();
            }
        }

        async function onDCLDistrictChange() {
            const stateSelect = document.getElementById('dcl-state');
            const districtSelect = document.getElementById('dcl-district');
            
            const stateCode = stateSelect.value;
            const districtCode = districtSelect.value;
            
            if (!stateCode || !districtCode) return;
            
            showLoading();
            
            try {
                const response = await fetch('/api/district-causelist/court-complexes', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        state_code: stateCode,
                        district_code: districtCode,
                        session_id: districtCauseListSessionId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const complexSelect = document.getElementById('dcl-court-complex');
                    complexSelect.innerHTML = '<option value="">Select Court Complex</option>';
                    
                    Object.entries(data.court_complexes).forEach(([name, code]) => {
                        const option = document.createElement('option');
                        option.value = code;
                        option.textContent = name;
                        option.dataset.name = name;
                        complexSelect.appendChild(option);
                    });
                    
                    // Reset dependent dropdowns
                    document.getElementById('dcl-establishment').innerHTML = '<option value="">Select court complex first</option>';
                    document.getElementById('dcl-judge').innerHTML = '<option value="">Select establishment first</option>';
                }
            } catch (error) {
                showAlert('Failed to load court complexes', 'error');
            } finally {
                hideLoading();
            }
        }

        async function onDCLComplexChange() {
            const stateSelect = document.getElementById('dcl-state');
            const districtSelect = document.getElementById('dcl-district');
            const complexSelect = document.getElementById('dcl-court-complex');
            
            const stateCode = stateSelect.value;
            const districtCode = districtSelect.value;
            const complexCode = complexSelect.value;
            
            if (!stateCode || !districtCode || !complexCode) return;
            
            showLoading();
            
            try {
                const response = await fetch('/api/district-causelist/establishments', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        state_code: stateCode,
                        district_code: districtCode,
                        court_complex_code: complexCode,
                        session_id: districtCauseListSessionId
                    })
                });
                
                const data = await response.json();
                
                console.log('Establishments API response:', data);
                
                if (data.success) {
                    const estSelect = document.getElementById('dcl-establishment');
                    const judgeSelect = document.getElementById('dcl-judge');
                    
                    console.log('Establishments data:', data.establishments);
                    
                    // Check if establishments object is empty or has the special marker
                    const hasEstablishments = data.establishments && Object.keys(data.establishments).length > 0;
                    const hasNoEstablishmentMarker = data.establishments && data.establishments.__no_establishment__;
                    
                    // Check if establishment dropdown is needed
                    if (hasNoEstablishmentMarker || !hasEstablishments) {
                        console.log('No establishment dropdown needed, fetching judges directly');
                        // Hide establishment dropdown, directly fetch judges
                        estSelect.style.display = 'none';
                        estSelect.parentElement.style.display = 'none';
                        estSelect.value = '__no_establishment__';
                        
                        // Directly fetch judges
                        await fetchJudgesForComplex(stateCode, districtCode, complexCode, '__no_establishment__');
                    } else {
                        console.log('Showing establishment dropdown with', Object.keys(data.establishments).length, 'options');
                        // Show establishment dropdown
                        estSelect.style.display = 'block';
                        estSelect.parentElement.style.display = 'block';
                        estSelect.innerHTML = '<option value="">Select Establishment</option>';
                        
                        Object.entries(data.establishments).forEach(([name, code]) => {
                            const option = document.createElement('option');
                            option.value = code;
                            option.textContent = name;
                            option.dataset.name = name;
                            estSelect.appendChild(option);
                        });
                        
                        // Reset judge dropdown
                        judgeSelect.innerHTML = '<option value="">Select establishment first</option>';
                    }
                } else {
                    console.error('API returned error:', data.error);
                    showAlert('Error loading establishments: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Exception loading establishments:', error);
                showAlert('Failed to load establishments: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        async function fetchJudgesForComplex(stateCode, districtCode, complexCode, estCode) {
            try {
                const response = await fetch('/api/district-causelist/judges', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        state_code: stateCode,
                        district_code: districtCode,
                        court_complex_code: complexCode,
                        est_code: estCode,
                        session_id: districtCauseListSessionId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const judgeSelect = document.getElementById('dcl-judge');
                    judgeSelect.innerHTML = '<option value="">Select Judge/Court</option>';
                    
                    // Backend returns {code: name}, so swap the order
                    Object.entries(data.judges).forEach(([code, name]) => {
                        const option = document.createElement('option');
                        option.value = code;
                        option.textContent = name;
                        option.dataset.name = name;
                        judgeSelect.appendChild(option);
                    });
                }
            } catch (error) {
                showAlert('Failed to load judges', 'error');
            }
        }

        async function onDCLEstablishmentChange() {
            const stateSelect = document.getElementById('dcl-state');
            const districtSelect = document.getElementById('dcl-district');
            const complexSelect = document.getElementById('dcl-court-complex');
            const estSelect = document.getElementById('dcl-establishment');
            
            const stateCode = stateSelect.value;
            const districtCode = districtSelect.value;
            const complexCode = complexSelect.value;
            const estCode = estSelect.value;
            
            if (!stateCode || !districtCode || !complexCode || !estCode) return;
            
            showLoading();
            
            try {
                const response = await fetch('/api/district-causelist/judges', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        state_code: stateCode,
                        district_code: districtCode,
                        court_complex_code: complexCode,
                        est_code: estCode,
                        session_id: districtCauseListSessionId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const judgeSelect = document.getElementById('dcl-judge');
                    judgeSelect.innerHTML = '<option value="">Select Judge/Court</option>';
                    
                    // Backend returns {code: name}, so swap the order
                    Object.entries(data.judges).forEach(([code, name]) => {
                        const option = document.createElement('option');
                        option.value = code;
                        option.textContent = name;
                        option.dataset.name = name;
                        judgeSelect.appendChild(option);
                    });
                }
            } catch (error) {
                showAlert('Failed to load judges', 'error');
            } finally {
                hideLoading();
            }
        }

        async function searchDistrictCauseList() {
            const stateSelect = document.getElementById('dcl-state');
            const districtSelect = document.getElementById('dcl-district');
            const complexSelect = document.getElementById('dcl-court-complex');
            const estSelect = document.getElementById('dcl-establishment');
            const judgeSelect = document.getElementById('dcl-judge');
            const dateInput = document.getElementById('dcl-date').value;
            const caseType = document.getElementById('dcl-case-type').value;
            const searchType = document.getElementById('dcl-search-type').value;
            const searchTerm = document.getElementById('dcl-search-term').value.trim();
            
            // Check if establishment is hidden (optional)
            const isEstablishmentHidden = estSelect.style.display === 'none';
            
            if (!stateSelect.value || !districtSelect.value || !complexSelect.value || 
                !judgeSelect.value || !dateInput || !searchTerm) {
                showAlert('Please fill all required fields', 'error');
                return;
            }
            
            // If establishment is visible, it must be selected
            if (!isEstablishmentHidden && !estSelect.value) {
                showAlert('Please select establishment', 'error');
                return;
            }
            
            // Convert date from YYYY-MM-DD to DD-MM-YYYY
            const dateParts = dateInput.split('-');
            const formattedDate = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;
            
            showLoading();
            
            currentQueryData = {
                state_code: stateSelect.value,
                state_name: stateSelect.options[stateSelect.selectedIndex]?.dataset?.name || '',
                district_code: districtSelect.value,
                district_name: districtSelect.options[districtSelect.selectedIndex]?.textContent || '',
                court_complex_code: complexSelect.value,
                court_complex_name: complexSelect.options[complexSelect.selectedIndex]?.textContent || '',
                est_code: estSelect.value || '__no_establishment__',
                est_name: (estSelect.style.display === 'none') ? 'N/A' : (estSelect.options[estSelect.selectedIndex]?.textContent || ''),
                court_no: judgeSelect.value,
                court_name: judgeSelect.options[judgeSelect.selectedIndex]?.textContent || '',
                date: formattedDate,
                case_type: caseType,
                search_term: searchTerm,
                is_party_name: searchType === 'party_name',
                dropdown_session_id: districtCauseListSessionId  // Pass the dropdown session
            };
            
            try {
                const response = await fetch('/api/district-causelist/search', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(currentQueryData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentQueryData.query_id = data.query_id;
                    currentQueryData.session_id = data.session_id;
                    showCaptcha(data.captcha_url);
                } else {
                    showAlert(data.error || 'Failed to initialize search', 'error');
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // ==================== END DISTRICT CAUSELIST FUNCTIONS ====================


        function showCaptcha(captchaUrl) {
            document.getElementById('captcha-image').src = captchaUrl;
            document.getElementById('captcha-input').value = '';
            document.getElementById('captcha-modal').classList.remove('hidden');
        }

        async function submitCaptcha() {
            const captcha = document.getElementById('captcha-input').value;
            
            if (!captcha) {
                showAlert('Please enter captcha', 'error');
                return;
            }
            
            showLoading();
            document.getElementById('captcha-modal').classList.add('hidden');
            
            let endpoint;
            if (currentCourtType === 'high-court') {
                endpoint = '/api/high-court/verify-captcha';
            } else if (currentCourtType === 'district-court') {
                endpoint = '/api/district-court/verify-captcha';
            } else if (currentCourtType === 'causelist') {
                endpoint = '/api/causelist/verify-captcha';
            } else if (currentCourtType === 'district-causelist') {
                endpoint = '/api/district-causelist/verify-captcha';
            }
            
            try {
                // Special handling for causelist PDF processing with progress
                if (currentCourtType === 'causelist') {
                    showLoading('Analyzing cause list PDFs - Please wait, this may take a few minutes...');
                    updateProgress(0, 100, 'Starting PDF analysis...');
                    
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            ...currentQueryData,
                            captcha: captcha
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        updateProgress(100, 100, `Completed! Found ${data.results.total_matches} matches in ${data.results.pdfs_with_matches} PDFs`);
                        setTimeout(() => {
                            showAlert('Search completed!', 'success');
                            displayCauseListResults(data.results);
                            hideLoading();
                        }, 1000);
                        return; // Don't hide loading yet
                    } else {
                        showAlert(data.error || 'Failed to fetch data', 'error');
                    }
                } else if (currentCourtType === 'district-causelist') {
                    showLoading('Fetching and analyzing district cause list...');
                    
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            ...currentQueryData,
                            captcha: captcha
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showAlert('Search completed!', 'success');
                        displayDistrictCauseListResults(data.results);
                    } else {
                        showAlert(data.error || 'Failed to fetch data', 'error');
                    }
                } else {
                    // Regular processing for other court types
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            ...currentQueryData,
                            captcha: captcha
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showAlert('Case found successfully!', 'success');
                        displayResults(data.case_data);
                    } else {
                        showAlert(data.error || 'Failed to fetch data', 'error');
                    }
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            } finally {
                if (currentCourtType !== 'causelist') {
                    hideLoading();
                }
            }
        }

        function displayResults(caseData) {
            const container = document.getElementById('results-content');
            container.innerHTML = '';
            
            // Display case details
            if (caseData.case_details) {
                const detailsCard = document.createElement('div');
                detailsCard.className = 'result-card';
                detailsCard.innerHTML = '<h3>üìã Case Details</h3>';
                
                Object.entries(caseData.case_details).forEach(([key, value]) => {
                    const item = document.createElement('div');
                    item.className = 'result-item';
                    item.innerHTML = `
                        <div class="result-label">${key}:</div>
                        <div class="result-value">${value}</div>
                    `;
                    detailsCard.appendChild(item);
                });
                
                container.appendChild(detailsCard);
            }
            
            // Display case status
            if (caseData.case_status) {
                const statusCard = document.createElement('div');
                statusCard.className = 'result-card';
                statusCard.innerHTML = '<h3>‚öñÔ∏è Case Status</h3>';
                
                Object.entries(caseData.case_status).forEach(([key, value]) => {
                    const item = document.createElement('div');
                    item.className = 'result-item';
                    item.innerHTML = `
                        <div class="result-label">${key}:</div>
                        <div class="result-value">${value}</div>
                    `;
                    statusCard.appendChild(item);
                });
                
                container.appendChild(statusCard);
            }
            
            // Display parties
            if (caseData.parties) {
                const partiesCard = document.createElement('div');
                partiesCard.className = 'result-card';
                partiesCard.innerHTML = '<h3>üë• Parties</h3>';
                
                if (caseData.parties.petitioner) {
                    const item = document.createElement('div');
                    item.className = 'result-item';
                    item.innerHTML = `
                        <div class="result-label">Petitioner:</div>
                        <div class="result-value">${caseData.parties.petitioner}</div>
                    `;
                    partiesCard.appendChild(item);
                }
                
                if (caseData.parties.respondent) {
                    const item = document.createElement('div');
                    item.className = 'result-item';
                    item.innerHTML = `
                        <div class="result-label">Respondent:</div>
                        <div class="result-value">${caseData.parties.respondent}</div>
                    `;
                    partiesCard.appendChild(item);
                }
                
                if (caseData.parties.petitioners && caseData.parties.petitioners.length > 0) {
                    const item = document.createElement('div');
                    item.className = 'result-item';
                    item.innerHTML = `
                        <div class="result-label">Petitioners:</div>
                        <div class="result-value">${caseData.parties.petitioners.map(p => p.name).join(', ')}</div>
                    `;
                    partiesCard.appendChild(item);
                }
                
                if (caseData.parties.respondents && caseData.parties.respondents.length > 0) {
                    const item = document.createElement('div');
                    item.className = 'result-item';
                    item.innerHTML = `
                        <div class="result-label">Respondents:</div>
                        <div class="result-value">${caseData.parties.respondents.map(p => p.name).join(', ')}</div>
                    `;
                    partiesCard.appendChild(item);
                }
                
                container.appendChild(partiesCard);
            }
            
            // Display Acts (for district courts)
            if (caseData.acts && caseData.acts.length > 0) {
                const actsCard = document.createElement('div');
                actsCard.className = 'result-card';
                actsCard.innerHTML = '<h3>üìú Acts and Sections</h3>';
                
                caseData.acts.forEach(act => {
                    const actDiv = document.createElement('div');
                    actDiv.className = 'result-item';
                    actDiv.innerHTML = `
                        <div class="result-label">${act.act}:</div>
                        <div class="result-value">Section(s): ${act.sections}</div>
                    `;
                    actsCard.appendChild(actDiv);
                });
                
                container.appendChild(actsCard);
            }
            
            // Display subordinate court information (for district courts)
            if (caseData.subordinate_court) {
                const subCourtCard = document.createElement('div');
                subCourtCard.className = 'result-card';
                subCourtCard.innerHTML = '<h3>üèõÔ∏è Subordinate Court Information</h3>';
                
                Object.entries(caseData.subordinate_court).forEach(([key, value]) => {
                    const item = document.createElement('div');
                    item.className = 'result-item';
                    item.innerHTML = `
                        <div class="result-label">${key}:</div>
                        <div class="result-value">${value}</div>
                    `;
                    subCourtCard.appendChild(item);
                });
                
                container.appendChild(subCourtCard);
            }
            
            // Display court info (for high courts)
            if (caseData.court_info) {
                const courtCard = document.createElement('div');
                courtCard.className = 'result-card';
                courtCard.innerHTML = '<h3>üèõÔ∏è Court Information</h3>';
                
                Object.entries(caseData.court_info).forEach(([key, value]) => {
                    const item = document.createElement('div');
                    item.className = 'result-item';
                    item.innerHTML = `
                        <div class="result-label">${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}:</div>
                        <div class="result-value">${value}</div>
                    `;
                    courtCard.appendChild(item);
                });
                
                container.appendChild(courtCard);
            }
            
            // Display orders
            if (caseData.orders && caseData.orders.length > 0) {
                const ordersCard = document.createElement('div');
                ordersCard.className = 'result-card';
                ordersCard.innerHTML = '<h3>üìÑ Orders/Judgments</h3>';
                
                caseData.orders.forEach(order => {
                    const orderDiv = document.createElement('div');
                    orderDiv.className = 'order-item';
                    
                    let orderHtml = `
                        <div style="margin-bottom: 10px; padding: 10px; border-left: 3px solid #7c3aed; background: #f9fafb;">
                            <div style="font-weight: bold; color: #7c3aed;">Order #${order.order_number}</div>
                            <div style="margin-top: 5px;">üìÖ Date: ${order.order_date || order.order_on || 'N/A'}</div>
                    `;
                    
                    if (order.judge) {
                        orderHtml += `<div style="margin-top: 5px;">üë®‚Äç‚öñÔ∏è Judge: ${order.judge}</div>`;
                    }
                    
                    if (order.details) {
                        orderHtml += `<div style="margin-top: 5px;">üìã Details: ${order.details}</div>`;
                    }
                    
                    // Add view link - check for pdf_url (new in-memory cache) or pdf_id first, then fallback to external links
                    if (order.pdf_url) {
                        // Use the PDF URL from in-memory cache (works on Render)
                        orderHtml += `
                            <div style="margin-top: 10px;">
                                <a href="${order.pdf_url}" target="_blank" 
                                   style="display: inline-block; padding: 8px 16px; background: #7c3aed; color: white; 
                                          text-decoration: none; border-radius: 4px; font-weight: bold;">
                                    üì• View Order/Judgment (Downloaded)
                                </a>
                            </div>
                        `;
                    } else if (order.pdf_id) {
                        // Fallback: construct URL from pdf_id
                        const pdfUrl = `/api/download-pdf/${order.pdf_id}`;
                        orderHtml += `
                            <div style="margin-top: 10px;">
                                <a href="${pdfUrl}" target="_blank" 
                                   style="display: inline-block; padding: 8px 16px; background: #7c3aed; color: white; 
                                          text-decoration: none; border-radius: 4px; font-weight: bold;">
                                    üì• View Order/Judgment (Downloaded)
                                </a>
                            </div>
                        `;
                    } else if (order.local_pdf_path) {
                        // Legacy support for old disk-based downloads
                        const pdfUrl = `/api/download-pdf/${order.local_pdf_path}`;
                        orderHtml += `
                            <div style="margin-top: 10px;">
                                <a href="${pdfUrl}" target="_blank" 
                                   style="display: inline-block; padding: 8px 16px; background: #7c3aed; color: white; 
                                          text-decoration: none; border-radius: 4px; font-weight: bold;">
                                    üì• View Order/Judgment (Downloaded)
                                </a>
                            </div>
                        `;
                    } else if (order.view_link) {
                        // Fallback to external High Court link
                        const baseUrl = 'https://hcservices.ecourts.gov.in/hcservices/';
                        const fullUrl = baseUrl + order.view_link;
                        orderHtml += `
                            <div style="margin-top: 10px;">
                                <a href="${fullUrl}" target="_blank" 
                                   style="display: inline-block; padding: 8px 16px; background: #7c3aed; color: white; 
                                          text-decoration: none; border-radius: 4px; font-weight: bold;">
                                    üì• View Order/Judgment
                                </a>
                            </div>
                        `;
                    } else if (order.pdf_link) {
                        // Fallback to external District Court link
                        // Parse the displayPdf function call to extract parameters
                        const match = order.pdf_link.match(/displayPdf\('([^']+)'\)/);
                        if (match) {
                            const params = match[1];
                            // The params are in format: home/display_pdf&filename=...&caseno=...
                            // We need to convert this to a proper query string
                            const baseUrl = 'https://services.ecourts.gov.in/ecourtindia_v6/';
                            
                            // Extract the path and query parameters
                            const parts = params.split('&');
                            if (parts.length > 0) {
                                const path = parts[0]; // e.g., "home/display_pdf"
                                const queryParams = parts.slice(1).join('&'); // e.g., "filename=...&caseno=..."
                                
                                // Construct the full URL
                                const fullUrl = `${baseUrl}${path}?${queryParams}`;
                                
                                orderHtml += `
                                    <div style="margin-top: 10px;">
                                        <a href="${fullUrl}" target="_blank" 
                                           style="display: inline-block; padding: 8px 16px; background: #7c3aed; color: white; 
                                                  text-decoration: none; border-radius: 4px; font-weight: bold;">
                                            üì• View Order/Judgment PDF
                                        </a>
                                    </div>
                                `;
                            }
                        }
                    }
                    
                    orderHtml += `</div>`;
                    orderDiv.innerHTML = orderHtml;
                    ordersCard.appendChild(orderDiv);
                });
                
                container.appendChild(ordersCard);
            }
            
            // Display hearings
            if (caseData.hearings && caseData.hearings.length > 0) {
                const hearingsCard = document.createElement('div');
                hearingsCard.className = 'result-card';
                hearingsCard.innerHTML = `
                    <h3>üìÖ Hearing History</h3>
                    <p style="color: #666; font-size: 14px;">Showing last ${Math.min(15, caseData.hearings.length)} hearings</p>
                `;
                
                caseData.hearings.slice(0, 15).forEach((hearing, index) => {
                    const hearingDiv = document.createElement('div');
                    hearingDiv.className = 'order-item';
                    
                    let hearingHtml = `
                        <div style="margin-bottom: 10px; padding: 10px; background: ${index % 2 === 0 ? '#f9fafb' : '#ffffff'}; border-left: 2px solid #7c3aed;">
                    `;
                    
                    if (hearing.business_on_date) {
                        hearingHtml += `<div><strong>üìÖ Business Date:</strong> ${hearing.business_on_date}</div>`;
                    }
                    
                    if (hearing.hearing_date) {
                        hearingHtml += `<div><strong>üìÖ Hearing Date:</strong> ${hearing.hearing_date}</div>`;
                    }
                    
                    if (hearing.purpose) {
                        hearingHtml += `<div><strong>üìã Purpose:</strong> ${hearing.purpose}</div>`;
                    }
                    
                    if (hearing.judge) {
                        hearingHtml += `<div><strong>üë®‚Äç‚öñÔ∏è Judge:</strong> ${hearing.judge}</div>`;
                    }
                    
                    hearingHtml += `</div>`;
                    hearingDiv.innerHTML = hearingHtml;
                    hearingsCard.appendChild(hearingDiv);
                });
                
                if (caseData.hearings.length > 15) {
                    const moreDiv = document.createElement('div');
                    moreDiv.style.cssText = 'text-align: center; margin-top: 10px; color: #7c3aed; font-style: italic;';
                    moreDiv.textContent = `+ ${caseData.hearings.length - 15} more hearings available`;
                    hearingsCard.appendChild(moreDiv);
                }
                
                container.appendChild(hearingsCard);
            }
            
            document.getElementById('results-container').classList.remove('hidden');
        }

        function displayDistrictCauseListResults(results) {
            const container = document.getElementById('results-content');
            container.innerHTML = '';
            
            // Display search summary
            const summaryCard = document.createElement('div');
            summaryCard.className = 'result-card';
            summaryCard.innerHTML = `
                <h3>üîç Search Summary</h3>
                <div class="result-item">
                    <div class="result-label">Court Name:</div>
                    <div class="result-value">${results.court_name || 'N/A'}</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Date:</div>
                    <div class="result-value">${results.date}</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Search Term:</div>
                    <div class="result-value">${results.search_term}</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Search Type:</div>
                    <div class="result-value">${results.search_type === 'party_name' ? 'Party Name' : 'Case Number'}</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Total Cases:</div>
                    <div class="result-value">${results.total_cases || 0}</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Matches Found:</div>
                    <div class="result-value">${results.match_count || 0}</div>
                </div>
            `;
            container.appendChild(summaryCard);
            
            // Display message if no records or error
            if (results.status === 'no_records') {
                const noRecordCard = document.createElement('div');
                noRecordCard.className = 'result-card';
                noRecordCard.innerHTML = `
                    <h3>‚ÑπÔ∏è No Records</h3>
                    <p>${results.message || 'No cause list found for the selected date and court.'}</p>
                `;
                container.appendChild(noRecordCard);
            } else if (results.status === 'error') {
                const errorCard = document.createElement('div');
                errorCard.className = 'result-card';
                errorCard.innerHTML = `
                    <h3>‚ùå Error</h3>
                    <p>${results.message || 'Failed to fetch cause list.'}</p>
                `;
                container.appendChild(errorCard);
            } else if (!results.matches || results.matches.length === 0) {
                const noMatchCard = document.createElement('div');
                noMatchCard.className = 'result-card';
                noMatchCard.innerHTML = `
                    <h3>‚ÑπÔ∏è No Matches Found</h3>
                    <p>The search term was not found in the cause list for this date.</p>
                `;
                container.appendChild(noMatchCard);
            } else {
                // Display matching cases
                results.matches.forEach((caseData, index) => {
                    const caseCard = document.createElement('div');
                    caseCard.className = 'result-card';
                    caseCard.innerHTML = `
                        <h3>üìã Match ${index + 1}</h3>
                    `;
                    
                    // Display all fields from the case
                    Object.entries(caseData).forEach(([key, value]) => {
                        if (value && value !== '') {
                            const item = document.createElement('div');
                            item.className = 'result-item';
                            item.innerHTML = `
                                <div class="result-label">${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}:</div>
                                <div class="result-value">${value}</div>
                            `;
                            caseCard.appendChild(item);
                        }
                    });
                    
                    container.appendChild(caseCard);
                });
            }
            
            // Display all cases from the cause list
            if (results.all_cases && results.all_cases.length > 0) {
                const allCasesHeader = document.createElement('div');
                allCasesHeader.className = 'result-card';
                allCasesHeader.innerHTML = `
                    <h3>üìã Complete Cause List for ${results.date}</h3>
                    <p>Showing all ${results.all_cases.length} cases listed for this date</p>
                `;
                container.appendChild(allCasesHeader);
                
                results.all_cases.forEach((caseData, index) => {
                    const caseCard = document.createElement('div');
                    caseCard.className = 'result-card';
                    caseCard.style.cssText = 'background: #f9fafb; border-left: 3px solid #9ca3af;';
                    caseCard.innerHTML = `
                        <h4 style="margin-bottom: 10px;">Case ${index + 1}</h4>
                    `;
                    
                    // Display all fields from the case
                    Object.entries(caseData).forEach(([key, value]) => {
                        if (value && value !== '') {
                            const item = document.createElement('div');
                            item.className = 'result-item';
                            item.innerHTML = `
                                <div class="result-label">${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}:</div>
                                <div class="result-value">${value}</div>
                            `;
                            caseCard.appendChild(item);
                        }
                    });
                    
                    container.appendChild(caseCard);
                });
            }
            
            document.getElementById('results-container').classList.remove('hidden');
        }

        function displayCauseListResults(results) {
            const container = document.getElementById('results-content');
            container.innerHTML = '';
            
            // Store session_id for PDF downloads
            if (results.session_id) {
                causelistSessionId = results.session_id;
                console.log('[INFO] Stored causelist session_id for PDF downloads:', causelistSessionId);
            }
            
            // Display search summary
            const summaryCard = document.createElement('div');
            summaryCard.className = 'result-card';
            summaryCard.innerHTML = `
                <h3>üîç Search Summary</h3>
                <div class="result-item">
                    <div class="result-label">Search Term:</div>
                    <div class="result-value">${results.search_term}</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Search Type:</div>
                    <div class="result-value">${results.search_type === 'party_name' ? 'Party Name' : 'Case Number'}</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Total PDFs Scanned:</div>
                    <div class="result-value">${results.total_pdfs_scanned}</div>
                </div>
                <div class="result-item">
                    <div class="result-label">PDFs with Matches:</div>
                    <div class="result-value">${results.pdfs_with_matches}</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Total Matches Found:</div>
                    <div class="result-value">${results.total_matches}</div>
                </div>
            `;
            container.appendChild(summaryCard);
            
            // Display message if no matches
            if (results.matching_pdfs.length === 0) {
                const noMatchCard = document.createElement('div');
                noMatchCard.className = 'result-card';
                noMatchCard.innerHTML = `
                    <h3>‚ÑπÔ∏è No Matches Found</h3>
                    <p>${results.message || 'The search term was not found in any of the cause list PDFs for the selected date.'}</p>
                `;
                container.appendChild(noMatchCard);
            } else {
                // Display matching PDFs
                results.matching_pdfs.forEach((pdf, index) => {
                    const pdfCard = document.createElement('div');
                    pdfCard.className = 'result-card';
                    pdfCard.innerHTML = `
                        <h3>üìÑ Match ${index + 1}: ${pdf.bench}</h3>
                        <div class="result-item">
                            <div class="result-label">SR No:</div>
                            <div class="result-value">${pdf.sr_no}</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Type:</div>
                            <div class="result-value">${pdf.type}</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Matches in PDF:</div>
                            <div class="result-value">${pdf.match_count}</div>
                        </div>
                        <div style="margin-top: 15px;">
                            <a href="${pdf.pdf_url}" target="_blank" 
                               style="display: inline-block; padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                                      color: white; text-decoration: none; border-radius: 8px; font-weight: bold;">
                                üì• View Cause List PDF
                            </a>
                        </div>
                    `;
                    
                    // Display matches
                    if (pdf.matches && pdf.matches.length > 0) {
                        const matchesDiv = document.createElement('div');
                        matchesDiv.style.cssText = 'margin-top: 15px; padding: 15px; background: #f9fafb; border-radius: 8px;';
                        matchesDiv.innerHTML = '<h4 style="margin-bottom: 10px; color: #667eea;">Case Details:</h4>';
                        
                        pdf.matches.forEach((match, matchIdx) => {
                            const matchItem = document.createElement('div');
                            matchItem.style.cssText = 'margin-bottom: 15px; padding: 10px; background: white; border-left: 3px solid #667eea;';
                            matchItem.innerHTML = `
                                <div style="margin-bottom: 5px;"><strong>Match #${matchIdx + 1}:</strong></div>
                                <div style="margin-bottom: 5px;"><strong>Found at line:</strong> ${match.line_number}</div>
                                <div style="margin-bottom: 5px;"><strong>Matched line:</strong> ${match.matched_line}</div>
                                <div style="margin-top: 10px; padding: 10px; background: #f3f4f6; border-radius: 4px; white-space: pre-wrap; font-family: monospace; font-size: 12px;">
                                    ${match.full_case_entry}
                                </div>
                            `;
                            matchesDiv.appendChild(matchItem);
                        });
                        
                        pdfCard.appendChild(matchesDiv);
                    }
                    
                    container.appendChild(pdfCard);
                });
            }
            
            // Display all PDFs from the cause list
            if (results.all_pdfs && results.all_pdfs.length > 0) {
                const allPdfsHeader = document.createElement('div');
                allPdfsHeader.className = 'result-card';
                allPdfsHeader.innerHTML = `
                    <h3>üìã Complete Cause List PDFs</h3>
                    <p>All ${results.all_pdfs.length} cause list PDFs available for this date</p>
                `;
                container.appendChild(allPdfsHeader);
                
                results.all_pdfs.forEach((item, index) => {
                    const pdfCard = document.createElement('div');
                    pdfCard.className = 'result-card';
                    pdfCard.style.cssText = 'background: #f9fafb; border-left: 3px solid #9ca3af;';
                    pdfCard.innerHTML = `
                        <h4 style="margin-bottom: 10px;">PDF ${index + 1}: ${item.bench}</h4>
                        <div class="result-item">
                            <div class="result-label">SR No:</div>
                            <div class="result-value">${item.sr_no}</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Type:</div>
                            <div class="result-value">${item.type}</div>
                        </div>
                        <div style="margin-top: 15px;">
                            <button onclick="viewProxiedPDF('${item.pdf_link.replace(/'/g, "\\'")}', '${item.bench.replace(/'/g, "\\'")}')" 
                               style="display: inline-block; padding: 10px 20px; background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%); 
                                      color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
                                üì• View Cause List PDF
                            </button>
                        </div>
                    `;
                    container.appendChild(pdfCard);
                });
            }
            
            document.getElementById('results-container').classList.remove('hidden');
        }
        
        async function viewProxiedPDF(pdfUrl, benchName) {
            try {
                showLoading('Fetching PDF from eCourts...');
                
                const requestBody = { 
                    pdf_url: pdfUrl
                };
                
                // Use causelist session if available (most important for HC causelist)
                if (causelistSessionId) {
                    requestBody.session_id = causelistSessionId;
                    console.log('[INFO] Using causelist session:', causelistSessionId);
                } else if (currentQueryData && currentQueryData.session_id) {
                    // Fallback to other session types
                    requestBody.session_id = currentQueryData.session_id;
                    console.log('[INFO] Using query session:', currentQueryData.session_id);
                }
                
                const response = await fetch('/api/proxy-pdf', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(requestBody)
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    
                    // Check if it's actually a PDF
                    if (blob.size < 1000) {
                        hideLoading();
                        showAlert('Downloaded file is too small - may not be a valid PDF', 'error');
                        return;
                    }
                    
                    const url = window.URL.createObjectURL(blob);
                    window.open(url, '_blank');
                    hideLoading();
                    
                    // Clean up the URL after a delay
                    setTimeout(() => window.URL.revokeObjectURL(url), 60000);
                } else {
                    const error = await response.json();
                    hideLoading();
                    showAlert(error.error || 'Failed to fetch PDF from eCourts', 'error');
                }
            } catch (error) {
                hideLoading();
                showAlert('Error fetching PDF: ' + error.message, 'error');
            }
        }

        function showAlert(message, type) {
            const container = document.getElementById('alert-container');
            container.innerHTML = `
                <div class="alert alert-${type}">
                    ${message}
                </div>
            `;
            
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        function showLoading(message = 'Loading...') {
            document.getElementById('loading-indicator').classList.remove('hidden');
            document.getElementById('loading-message').textContent = message;
            document.getElementById('progress-container').style.display = 'none';
            document.getElementById('progress-log').style.display = 'none';
        }

        function updateProgress(current, total, message = '') {
            const progressContainer = document.getElementById('progress-container');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const progressLog = document.getElementById('progress-log');
            
            progressContainer.style.display = 'block';
            progressLog.style.display = 'block';
            
            const percentage = total > 0 ? Math.round((current / total) * 100) : 0;
            progressBar.style.width = percentage + '%';
            progressText.textContent = `Processing ${current} of ${total} (${percentage}%)`;
            
            if (message) {
                const logEntry = document.createElement('div');
                logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                logEntry.style.marginBottom = '3px';
                progressLog.appendChild(logEntry);
                
                // Auto-scroll to bottom
                progressLog.scrollTop = progressLog.scrollHeight;
                
                // Keep only last 20 entries
                while (progressLog.children.length > 20) {
                    progressLog.removeChild(progressLog.firstChild);
                }
            }
        }

        function hideLoading() {
            document.getElementById('loading-indicator').classList.add('hidden');
            document.getElementById('progress-container').style.display = 'none';
            document.getElementById('progress-log').style.display = 'none';
            document.getElementById('progress-log').innerHTML = '';
        }

        function hideResults() {
            document.getElementById('results-container').classList.add('hidden');
        }
    </script>
</body>
</html>
